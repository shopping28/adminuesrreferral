<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Game Controller</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: white; font-family: 'Hind Siliguri', sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #aaa; font-size: 1.2rem; margin-right: 15px; }
        h2 { margin: 0; color: #00ff00; font-family: 'Orbitron', sans-serif; }
        
        /* Cards */
        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        h3 { color: #00f2ff; margin-top: 0; border-bottom: 1px solid #222; padding-bottom: 10px; }
        
        /* Inputs */
        label { display: block; color: #ccc; margin-top: 10px; font-size: 0.9rem; }
        input[type="text"], input[type="number"], input[type="datetime-local"] { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-top: 5px; box-sizing: border-box; }
        input[type="file"] { background: #1a1a1a; padding: 10px; width: 100%; border: 1px solid #444; border-radius: 5px; margin-top: 5px; color: #fff; }

        /* Buttons */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; font-family: 'Hind Siliguri', sans-serif; transition: 0.3s; }
        .btn:hover { transform: scale(1.02); }
        .btn-purple { background: #9d00ff; color: white; }
        .btn-green { background: #00ff00; color: black; }
        .btn-blue { background: #00f2ff; color: black; }

        /* Stock Status */
        .stock-info { background: rgba(157, 0, 255, 0.1); border: 1px solid #9d00ff; padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
        .stock-count { font-size: 1.8rem; font-family: 'Orbitron'; color: #d48aff; font-weight: bold; }
        
        /* Custom Checkbox */
        .switch-container { display: flex; align-items: center; margin-top: 15px; background: rgba(0, 255, 136, 0.1); padding: 10px; border-radius: 5px; border: 1px solid #00ff88; }
        
        /* Categories */
        .cat-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 10px; }
        .cat-item { background: #222; padding: 8px; border-radius: 5px; border: 1px solid #444; display: flex; justify-content: space-between; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="home.html" class="back-btn">‚¨Ö</a>
            <h2>GAME CONTROLLER</h2>
        </div>

        <!-- 1. Question Stock & Manual Mode Section -->
        <div class="card" style="border-top: 3px solid #9d00ff;">
            <h3>üìö ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶Ç‡¶ï ‡¶ì ‡¶Æ‡ßã‡¶° ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            
            <!-- Stock Counter -->
            <div class="stock-info">
                <span>‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</span>
                <div class="stock-count" id="q-stock">Connecting...</div>
            </div>

            <!-- Manual Mode Toggle -->
            <div class="switch-container">
                <input type="checkbox" id="use-custom-check" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;">
                <label style="margin:0; color: #00ff88; font-weight: bold; cursor:pointer;" for="use-custom-check">
                    ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Æ‡ßã‡¶° ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶® (Stock Mode)
                </label>
            </div>

            <!-- Upload Area -->
            <div style="margin-top: 20px; background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px dashed #555;">
                <label style="margin-top:0;">‚ûï ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (JSON):</label>
                <input type="file" id="json-file" accept=".json">
                <button class="btn btn-purple" onclick="uploadJSON()">‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (Add to Stock)</button>
                <p id="upload-status" style="margin-top:10px; font-size:0.8rem; color: yellow; text-align: center;"></p>
            </div>
        </div>

        <!-- 2. General Game Settings -->
        <div class="card" style="border-top: 3px solid #00ff00;">
            <h3>‚öôÔ∏è ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶ó‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ó‡ßá‡¶Æ‡ßá)</label><input type="number" id="q-limit" value="10"></div>
                <div style="flex:1;"><label>‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü (‡¶∏‡ßá:)</label><input type="number" id="view-time" value="15"></div>
                <div style="flex:1;"><label>‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßü (‡¶∏‡ßá:)</label><input type="number" id="ans-time" value="25"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶∏‡¶Æ‡ßü</label><input type="datetime-local" id="start-time"></div>
                <div style="flex:1;"><label>‡¶∂‡ßá‡¶∑‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü</label><input type="datetime-local" id="end-time"></div>
            </div>
            <button class="btn btn-green" onclick="saveConfig()">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <!-- 3. AI Categories (Only used if Manual Mode is OFF) -->
        <div class="card" style="border-top: 3px solid #00f2ff;">
            <h3>üìÇ AI ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø (Backup)</h3>
            <p style="color:#777; font-size:0.8rem;">‡¶Ø‡¶¶‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤ ‡¶Æ‡ßã‡¶° ‡¶¨‡¶®‡ßç‡¶ß ‡¶•‡¶æ‡¶ï‡ßá, ‡¶§‡¶¨‡ßá AI ‡¶è‡¶ñ‡¶æ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶¨‡¶ø‡¶∑‡ßü ‡¶¨‡ßá‡¶õ‡ßá ‡¶®‡¶ø‡¶¨‡ßá‡•§</p>
            
            <div style="display:flex; gap:10px;">
                <input type="text" id="new-cat" placeholder="‡¶¨‡¶ø‡¶∑‡ßü ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®)">
                <button class="btn btn-blue" style="width:100px; margin-top:5px;" onclick="addCategory()">‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>

            <div class="cat-list" id="cat-list-div">Loading...</div>
            <button class="btn btn-green" style="margin-top:15px; background:#005c61; color:white;" onclick="saveActiveCats()">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, update, push, onValue, get, remove } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBVwD0U7_QeX8EyOrZ4fm7OG_ow1b391-M", authDomain: "game-f739d.firebaseapp.com", databaseURL: "https://game-f739d-default-rtdb.firebaseio.com", projectId: "game-f739d", storageBucket: "game-f739d.firebasestorage.app", messagingSenderId: "744868437950", appId: "1:744868437950:web:622410843c8aeb229463ef" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Security Check
        if(sessionStorage.getItem("admin_logged_in") !== "true") window.location.href = "login.html";

        // References
        const configRef = ref(db, 'settings/gameConfig');
        const catRef = ref(db, 'categories');
        const manualQRef = ref(db, 'manualQuestions');

        // 1. Load Settings & Stock Count
        onValue(configRef, (snap) => {
            const d = snap.val();
            if(d) {
                document.getElementById('start-time').value = d.startTime || "";
                document.getElementById('end-time').value = d.endTime || "";
                document.getElementById('q-limit').value = d.questionLimit || 10;
                document.getElementById('view-time').value = d.viewTime || 15;
                document.getElementById('ans-time').value = d.answerTime || 25;
                // Checkbox State
                document.getElementById('use-custom-check').checked = d.useCustomQuestions || false;
            }
        });

        // Live Stock Counter
        onValue(manualQRef, (snap) => {
            const count = snap.exists() ? Object.keys(snap.val()).length : 0;
            document.getElementById('q-stock').innerText = count;
        });

        // 2. Upload Function (Append Mode)
        window.uploadJSON = () => {
            const fileInput = document.getElementById('json-file');
            const status = document.getElementById('upload-status');

            if(fileInput.files.length === 0) {
                alert("‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®!");
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            status.innerText = "‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";

            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Validation
                    if(!Array.isArray(json)) throw new Error("JSON ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á Array ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü‡ßá ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá [...]");
                    if(json.length === 0) throw new Error("‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶ñ‡¶æ‡¶≤‡¶ø!");
                    if(!json[0].q || !json[0].c) throw new Error("JSON ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü (q, a, c ‡¶Æ‡¶ø‡¶∏‡¶ø‡¶Ç)");

                    // Prepare Updates (Append with Push ID)
                    const updates = {};
                    json.forEach(q => {
                        const newKey = push(manualQRef).key; // Create unique ID
                        updates[newKey] = q;
                    });

                    // Send to Firebase
                    update(manualQRef, updates).then(() => {
                        status.innerText = `‚úÖ ‡¶∏‡¶´‡¶≤! ${json.length} ‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                        alert("‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                        fileInput.value = ''; // Reset input
                    });

                } catch(err) {
                    status.innerText = "‚ùå ‡¶≠‡ßÅ‡¶≤: " + err.message;
                    alert("‡¶´‡¶æ‡¶á‡¶≤ ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶∏‡¶†‡¶ø‡¶ï ‡¶®‡ßü!");
                }
            };
            reader.readAsText(file);
        }

        // 3. Save All Configs
        window.saveConfig = () => {
            update(configRef, {
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
                questionLimit: parseInt(document.getElementById('q-limit').value),
                viewTime: parseInt(document.getElementById('view-time').value),
                answerTime: parseInt(document.getElementById('ans-time').value),
                useCustomQuestions: document.getElementById('use-custom-check').checked // Save Switch State
            }).then(() => alert("‚úÖ ‡¶∏‡¶ï‡¶≤ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
        }

        // 4. Category Management (Visual)
        onValue(catRef, (snap) => {
            const list = document.getElementById('cat-list-div');
            list.innerHTML = '';
            get(ref(db, 'settings/gameConfig/activeCats')).then(activeSnap => {
                const activeCats = activeSnap.val() ? activeSnap.val().split(',') : [];
                snap.forEach(c => {
                    const catName = c.val().name;
                    const catId = c.key;
                    const div = document.createElement('div');
                    div.className = 'cat-item';
                    const isChecked = activeCats.includes(catName) ? 'checked' : ''; 
                    
                    div.innerHTML = `
                        <label style="margin:0; cursor:pointer; display:flex; align-items:center;">
                            <input type="checkbox" value="${catName}" ${isChecked} style="width:auto; margin-right:8px;"> ${catName}
                        </label>
                        <span onclick="delCat('${catId}')" style="color:#ff4444; cursor:pointer; font-weight:bold;">‚úï</span>
                    `;
                    list.appendChild(div);
                });
            });
        });

        window.addCategory = () => {
            const name = document.getElementById('new-cat').value;
            if(name) { push(catRef, { name: name }); document.getElementById('new-cat').value = ''; }
        }

        window.delCat = (key) => { if(confirm("‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) remove(ref(db, 'categories/' + key)); }

        window.saveActiveCats = () => {
            const selected = [];
            document.querySelectorAll('#cat-list-div input:checked').forEach(c => selected.push(c.value));
            update(configRef, { activeCats: selected.join(',') }).then(() => alert("‚úÖ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
        }
    </script>
</body>
</html>
