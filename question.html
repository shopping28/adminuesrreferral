<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Question Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;600&family=Orbitron:wght@500&display=swap" rel="stylesheet">
    <style>
        body { background: #050505; color: white; font-family: 'Hind Siliguri', sans-serif; padding: 20px; margin: 0; }
        .container { max-width: 800px; margin: 0 auto; }
        
        .header { display: flex; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .back-btn { text-decoration: none; color: #aaa; font-size: 1.2rem; margin-right: 15px; }
        h2 { margin: 0; color: #00ff00; font-family: 'Orbitron', sans-serif; }

        .card { background: #111; border: 1px solid #333; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        h3 { color: #00f2ff; margin-top: 0; border-bottom: 1px solid #222; padding-bottom: 10px; }

        label { display: block; color: #ccc; margin-top: 10px; font-size: 0.9rem; }
        input { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; border-radius: 5px; margin-top: 5px; box-sizing: border-box; font-family: 'Hind Siliguri', sans-serif; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 15px; font-family: 'Hind Siliguri', sans-serif; transition: 0.3s; }
        .btn:hover { transform: scale(1.02); }
        .btn-green { background: #00ff00; color: black; }
        .btn-magic { background: linear-gradient(90deg, #6a11cb 0%, #2575fc 100%); color: white; box-shadow: 0 0 15px rgba(100, 100, 255, 0.3); }

        .cat-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 10px; }
        .cat-item { background: #1a1a1a; padding: 10px; border: 1px solid #333; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Loader */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #00f2ff; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; margin-right: 10px; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <a href="home.html" class="back-btn">‚¨Ö</a>
            <h2>AI QUESTION MANAGER</h2>
        </div>

        <!-- 1. Game Settings -->
        <div class="card">
            <h3>‚öôÔ∏è ‡¶ó‡ßá‡¶Æ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Questions Limit</label><input type="number" id="q-limit" value="10"></div>
                <div style="flex:1;"><label>View Time (Sec)</label><input type="number" id="view-time" value="15"></div>
                <div style="flex:1;"><label>Answer Time (Sec)</label><input type="number" id="ans-time" value="25"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>Start Time</label><input type="datetime-local" id="start-time"></div>
                <div style="flex:1;"><label>End Time</label><input type="datetime-local" id="end-time"></div>
            </div>
            <button class="btn btn-green" onclick="saveConfig()">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>

        <!-- 2. AI Generator -->
        <div class="card">
            <h3>ü§ñ AI ‡¶ú‡ßá‡¶®‡¶æ‡¶∞‡ßá‡¶ü‡¶∞ (Magic)</h3>
            <p style="color: #aaa; font-size: 0.9rem;">‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®, AI ‡¶Ö‡¶ü‡ßã‡¶Æ‡ßá‡¶ü‡¶ø‡¶ï ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶¨‡¶æ‡¶®‡¶ø‡ßü‡ßá ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶¨‡ßá‡•§</p>
            
            <label>‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø‡¶∞ ‡¶®‡¶æ‡¶Æ (‡¶¨‡¶ø‡¶∑‡ßü)</label>
            <input type="text" id="ai-topic" placeholder="‡¶Ø‡ßá‡¶Æ‡¶®: ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏, ‡¶Æ‡¶π‡¶æ‡¶ï‡¶æ‡¶∂ ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶®, ‡¶ï‡ßç‡¶∞‡¶ø‡¶ï‡ßá‡¶ü">
            
            <label>API Key (Gemini)</label>
            <input type="password" id="api-key" value="AIzaSyCovUDq2hDYJ30MRQa58XHhp0A0XUIlzqs" placeholder="Enter Gemini API Key">

            <button class="btn btn-magic" onclick="generateWithAI()">
                <div class="loader" id="ai-loader"></div> ‚ú® ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
            </button>
            <p id="ai-status" style="margin-top: 10px; color: #00f2ff;"></p>
        </div>

        <!-- 3. Active Categories -->
        <div class="card">
            <h3>üìÇ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</h3>
            <p style="font-size: 0.8rem; color: #777;">‡¶Ø‡ßá‡¶ó‡ßÅ‡¶≤‡ßã‡¶§‡ßá ‡¶ü‡¶ø‡¶ï ‡¶¶‡¶ø‡¶¨‡ßá‡¶®, ‡¶ó‡ßá‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶∏‡ßá‡¶á ‡¶ü‡¶™‡¶ø‡¶ï‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶Ü‡¶∏‡¶¨‡ßá‡•§</p>
            
            <div class="cat-list" id="cat-list-div">Loading...</div>
            <button class="btn btn-green" onclick="saveActiveCats()">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, update, push, onValue, set, get } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyBVwD0U7_QeX8EyOrZ4fm7OG_ow1b391-M", authDomain: "game-f739d.firebaseapp.com", databaseURL: "https://game-f739d-default-rtdb.firebaseio.com", projectId: "game-f739d", storageBucket: "game-f739d.firebasestorage.app", messagingSenderId: "744868437950", appId: "1:744868437950:web:622410843c8aeb229463ef" };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        if(sessionStorage.getItem("admin_logged_in") !== "true") window.location.href = "login.html";

        const configRef = ref(db, 'settings/gameConfig');
        const catRef = ref(db, 'categories');

        // Load Data
        onValue(configRef, (snap) => {
            const d = snap.val();
            if(d) {
                document.getElementById('start-time').value = d.startTime || "";
                document.getElementById('end-time').value = d.endTime || "";
                document.getElementById('q-limit').value = d.questionLimit || 10;
                document.getElementById('view-time').value = d.viewTime || 15;
                document.getElementById('ans-time').value = d.answerTime || 25;
            }
        });

        onValue(catRef, (snap) => {
            const list = document.getElementById('cat-list-div');
            list.innerHTML = '';
            
            get(ref(db, 'settings/gameConfig/activeCats')).then(activeSnap => {
                const activeCats = activeSnap.val() ? activeSnap.val().split(',') : [];
                snap.forEach(c => {
                    const catName = c.val().name;
                    const catId = c.key;
                    const div = document.createElement('div');
                    div.className = 'cat-item';
                    const isChecked = activeCats.includes(catId) ? 'checked' : '';
                    div.innerHTML = `<label style="margin:0; cursor:pointer;"><input type="checkbox" value="${catId}" ${isChecked}> ${catName}</label>`;
                    list.appendChild(div);
                });
            });
        });

        window.saveConfig = () => {
            update(configRef, {
                startTime: document.getElementById('start-time').value,
                endTime: document.getElementById('end-time').value,
                questionLimit: parseInt(document.getElementById('q-limit').value),
                viewTime: parseInt(document.getElementById('view-time').value),
                answerTime: parseInt(document.getElementById('ans-time').value)
            }).then(() => alert("‚úÖ ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
        }

        window.saveActiveCats = () => {
            const selected = [];
            document.querySelectorAll('input[type="checkbox"]:checked').forEach(c => selected.push(c.value));
            update(configRef, { activeCats: selected.join(',') }).then(() => alert("‚úÖ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
        }

        // --- AI GENERATION LOGIC ---
        window.generateWithAI = async () => {
            const topic = document.getElementById('ai-topic').value;
            const apiKey = document.getElementById('api-key').value;
            const loader = document.getElementById('ai-loader');
            const status = document.getElementById('ai-status');

            if(!topic || !apiKey) return alert("‡¶¨‡¶ø‡¶∑‡ßü ‡¶è‡¶¨‡¶Ç API Key ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®!");

            loader.style.display = 'inline-block';
            status.innerText = "AI ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶õ‡ßá... ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶® (‡ßß‡ß¶-‡ßß‡ß´ ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶°)";

            const prompt = `
                Generate 15 hard/premium multiple choice questions in Bengali about '${topic}'.
                Format strictly as a JSON array. 
                Structure: [{"q": "Question text in Bengali", "a": ["Option1", "Option2", "Option3", "Option4"], "c": "Exact Correct Option Text"}]
                Do NOT use markdown. Just raw JSON.
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                let text = data.candidates[0].content.parts[0].text;
                
                // Clean JSON
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const questions = JSON.parse(text);

                // 1. Create Category
                const newCatRef = await push(catRef, { name: topic });
                const catId = newCatRef.key;

                // 2. Save Questions
                const qRef = ref(db, 'questions');
                let count = 0;
                for(let q of questions) {
                    await push(qRef, {
                        category: catId,
                        q: q.q,
                        a: q.a,
                        c: q.c
                    });
                    count++;
                }

                status.innerText = `‚úÖ ‡¶∏‡¶´‡¶≤! "${topic}" ‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç ${count} ‡¶ü‡¶ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶°‡¶æ‡¶ü‡¶æ‡¶¨‡ßá‡¶∏‡ßá ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§`;
                document.getElementById('ai-topic').value = '';

            } catch (error) {
                console.error(error);
                status.innerText = "‚ùå ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                alert("API Error: " + error.message);
            } finally {
                loader.style.display = 'none';
            }
        }
    </script>
</body>
</html>
